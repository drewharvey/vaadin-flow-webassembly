<link rel="import" href="../bower_components/polymer/polymer-element.html">

<script src = './webdsp/webdsp.js' type = 'text/javascript'></script>

<dom-module id="webdsp-element">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <canvas id="canvas"></canvas>

    </template>

    <script>
        class WebdspElement extends Polymer.Element {

            static get is() {
                return 'webdsp-element';
            }

            static get properties() {
                return {
                    imageSrc: {
                        type: String
                    },
                    filter: {
                        type: String
                    },
                    imageData: {
                        type: Array
                    },
                    _webdsp: {
                        type: Object
                    },
                    _canvasCtx: {
                        type: Object
                    },
                    _filterMap: {
                        type: Object
                    }
                };
            }

            static get observers() {
                return [
                    '_drawImage(imageSrc, filter)'
                ]
            }

            ready() {
                super.ready();
                this._canvasCtx = this.$.canvas.getContext('2d');
                // load webassembly
                loadWASM().then(module => {
                    this._webdsp = module;
                    this._filterMap = {
                        'invert': this._webdsp.invert,
                        'dewdrops': this._webdsp.dewdrops
                    };
                });
            }

            _drawImage(src, filter) {
                var img = new Image();
                img.onload = () => {
                    this._drawToCanvas(img);
                    this._applyFilter(filter);
                };
                img.src = src;
            }

            _drawToCanvas(img) {
                this.$.canvas.width = img.width;
                this.$.canvas.height = img.height;
                this._canvasCtx.drawImage(img, 0, 0);
            }

            _applyFilter(filter) {
                if (filter) {
                    const filterMethod = this._filterMap[filter.toLowerCase()];
                    if (filterMethod) {
                        const imageData = this._getImageData();
                        imageData.data.set(filterMethod(imageData.data, this.$.canvas.width, this.$.canvas.height));
                        this._canvasCtx.putImageData(imageData, 0, 0);
                    }
                }
                this.imageData = this._getImageData().data;
            }

            _getImageData() {
                return this._canvasCtx.getImageData(0, 0, this.$.canvas.width, this.$.canvas.height);
            }

        }

        window.customElements.define(WebdspElement.is, WebdspElement);
    </script>
</dom-module>
